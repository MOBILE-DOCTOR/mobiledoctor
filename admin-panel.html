<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Mobile Doctor</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    h1 {
      color: #007bff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }
    th {
      background-color: #f4f4f4;
    }
    .btn {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }
    .btn-update { background-color: #28a745; }
    .btn-delete { background-color: #dc3545; }
  </style>
</head>
<body>
  <h1>Admin Panel - Manage Users</h1>
  <p id="adminEmail"></p>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Username</th>
        <th>Role</th>
        <th>Update Role</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>
  <script src="scripts.js"></script>
  <script>
    // Check if current user is admin
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        alert("Not logged in!");
        return window.location.href = "index.html";
      }

      const uid = user.uid;
      firebase.database().ref("users/" + uid).once("value").then(snapshot => {
        const data = snapshot.val();
        if (data.role !== "admin") {
          alert("Access denied. Only admins allowed.");
          return window.location.href = "dashboard.html";
        }

        document.getElementById("adminEmail").innerText = "Logged in as: " + data.email;
        loadUsers();
      });
    });

    // Load all users
    function loadUsers() {
      firebase.database().ref("users").once("value").then(snapshot => {
        const users = snapshot.val();
        const userTable = document.getElementById("userTable");
        userTable.innerHTML = "";

        Object.keys(users).forEach(uid => {
          const { email, username, role } = users[uid];
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${email}</td>
            <td>${username}</td>
            <td>${role || "user"}</td>
            <td>
              <select id="role-${uid}">
                <option value="user" ${role === "user" ? "selected" : ""}>User</option>
                <option value="manager" ${role === "manager" ? "selected" : ""}>Manager</option>
                <option value="admin" ${role === "admin" ? "selected" : ""}>Admin</option>
              </select>
              <button class="btn btn-update" onclick="updateRole('${uid}')">Update</button>
            </td>
            <td>
              <button class="btn btn-delete" onclick="deleteUser('${uid}')">Delete</button>
            </td>
          `;
          userTable.appendChild(tr);
        });
      });
    }

    // Update role
    function updateRole(uid) {
      const selectedRole = document.getElementById("role-" + uid).value;
      firebase.database().ref("users/" + uid + "/role").set(selectedRole)
        .then(() => alert("Role updated to " + selectedRole))
        .catch(err => alert("Error: " + err.message));
    }

    // Delete user
    function deleteUser(uid) {
      if (confirm("Are you sure you want to delete this user?")) {
        firebase.database().ref("users/" + uid).remove()
          .then(() => {
            alert("User deleted!");
            loadUsers();
          })
          .catch(err => alert("Error: " + err.message));
      }
    }
  </script>
</body>
</html>
